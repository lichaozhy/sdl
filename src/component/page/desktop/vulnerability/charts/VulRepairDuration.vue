<template>
	<div>
		<b-breadcrumb
			:items="[
				{ text: '管理', active: true },
				{ text: '漏洞修复时长', active: true },
			]"
		/>

		<chart-canvas
			style="height:500px"
			:options="{
				credits: { enabled: false },
				series: [{
					type: 'treemap',
					layoutAlgorithm: 'stripes',
					alternateStartingDirection: true,
					levels: [{
						level: 1,
						layoutAlgorithm: 'sliceAndDice',
						dataLabels: {
							enabled: true,
							align: 'left',
							verticalAlign: 'top',
							style: {
								fontSize: '15px',
								fontWeight: 'bold'
							}
						}
					}],
					data: [{
						id: 'A',
						name: '1工作日',
						color: '#dc3545'
					}, {
						id: 'B',
						name: '2工作日',
						color: '#ffc107'
					}, {
						id: 'C',
						name: '3工作日',
						color: '#17a2b8'
					}, {
					}, {
						id: 'D',
						name: '4工作日',
						color: '#DDDF00'
					}, {
					}, {
						id: 'E',
						name: '5工作日',
						color: '#24CBE5'
					}, {
					}, {
						id: 'F',
						name: '6工作日',
						color: '#64E572'
					}, {
					}, {
						id: 'G',
						name: '7工作日',
						color: '#FF9655'
					}, {
					}, {
						id: 'H',
						name: '8工作日',
						color: '#6AF9C4'
					}, {
						name: '信用卡中心',
						parent: 'A',
						value: 7
					}, {
						name: '天津分行',
						parent: 'A',
						value: 3
					}, {
						name: '上海分行',
						parent: 'A',
						value: 4
					}, {
						name: '信用卡中心',
						parent: 'B',
						value: 2
					}, {
						name: '天津分行',
						parent: 'B',
						value: 5
					}, {
						name: '上海分行',
						parent: 'B',
						value: 1
					}, {
						name: '信用卡中心',
						parent: 'C',
						value: 3
					}, {
						name: '天津分行',
						parent: 'C',
						value: 3
					}, {
						name: '上海分行',
						parent: 'C',
						value: 2
					}, {
						name: '信用卡中心',
						parent: 'D',
						value: 5
					},{
						name: '天津分行',
						parent: 'D',
						value: 1
					},{
						name: '上海分行',
						parent: 'D',
						value: 6
					},{
						name: '南宁分行',
						parent: 'D',
						value: 3
					},{
						name: '信用卡中心',
						parent: 'E',
						value: 7
					},{
						name: '天津分行',
						parent: 'E',
						value: 2
					},{
						name: '信用卡中心',
						parent: 'F',
						value: 4
					},{
						name: '天津分行',
						parent: 'F',
						value: 3
					},{
						name: '上海分行',
						parent: 'F',
						value: 6
					},{
						name: '信用卡中心',
						parent: 'G',
						value: 1
					},{
						name: '天津分行',
						parent: 'G',
						value: 7
					},{
						name: '上海分行',
						parent: 'G',
						value: 2
					},{
						name: '南昌分行',
						parent: 'G',
						value: 4
					},{
						name: '信用卡中心',
						parent: 'H',
						value: 4
					}]
				}],
				title: {
					text: null
				}
			}"
		/>

		<b-table
			bordered
			small
			striped
			overflow:hidden
			id="admin-overview-table"
			:items="renderData"
			:per-page="perPage"
			:current-page="currentPage"
			class="text-center overview-table"
			:fields="[
				{ key: 'general', label: '总属' },
				{ key: 'branch', label: '分属' },
				{ key: 'projectName', label: '项目名称' },
				{ key: 'projectGroup', label: '项目组' },
				{ key: 'vulnerabilityName', label: '漏洞名称' },
				{ key: 'level', label: '危害级别' },
				{ key: 'status', label: '修复情况' },
				{ key: 'repairTime', label: '平均修复时长' },
			]"
		>
			<template
				slot="repairTime"
				slot-scope="data"
			>{{ data.item.averageRepairTime }}个工作日</template>
		</b-table>

		<div class="mt-3">
			<b-pagination 
				v-model="currentPage" 
				:total-rows="rows" 
				align="center"
				:per-page="perPage"
				aria-controls="admin-overview-table"
			></b-pagination>
		</div>
	</div>
</template>

<script>
import bocData from '../../../../../plugin/backend/boc.json';

const REPAIR_TIME_MAPPING = {
	1: 'A',
	2: 'B',
	3: 'C',
	4: 'D',
	5: 'E',
	6: 'F',
	7: 'G',
	8: 'H',
};

export default {
	data() {
		return {
			bocData,
			repairTimeData: [{
				id: 'A',
				name: '1工作日',
				color: '#dc3545'
			}, {
				id: 'B',
				name: '2工作日',
				color: '#ffc107'
			}, {
				id: 'C',
				name: '3工作日',
				color: '#17a2b8'
			}, {
			}, {
				id: 'D',
				name: '4工作日',
				color: '#DDDF00'
			}, {
			}, {
				id: 'E',
				name: '5工作日',
				color: '#24CBE5'
			}, {
			}, {
				id: 'F',
				name: '6工作日',
				color: '#64E572'
			}, {
			}, {
				id: 'G',
				name: '7工作日',
				color: '#FF9655'
			}, {
			}, {
				id: 'H',
				name: '8工作日',
				color: '#6AF9C4'
			}],
			perPage: 6,
			currentPage: 1,
		}
	},
	computed: {
		renderData() {
			let clone = this.bocData.slice(0);

			return clone.sort((a, b) => {
				return a.averageRepairTime - b.averageRepairTime;
			});
		},
		rows() {
			return this.renderData.length;
		}		
	},
	created() {
		this.getRepairTimeData();
	},
	methods: {
		getRepairTimeData() {
			this.bocData.forEach(bocEle => {
				const repairTimeEven = this.repairTimeData.some(timeEle => {
					return timeEle.name === bocEle.branch;
				});

				if (!repairTimeEven) {
					this.repairTimeData.push({
						name: bocEle.branch,
						parent: REPAIR_TIME_MAPPING[bocEle.averageRepairTime],
						value: 1
					});
				} else {
					this.repairTimeData.forEach((timeEle, timeIndex) => {
						if (timeEle.name === bocEle.branch && timeEle.parent === REPAIR_TIME_MAPPING[bocEle.averageRepairTime]) {
							timeEle.value++;
						} else {
							if (timeIndex === this.repairTimeData.length -1) {
								this.repairTimeData.push({
									name: bocEle.branch,
									parent: REPAIR_TIME_MAPPING[bocEle.averageRepairTime],
									value: 1
								});
							}
						}
					});
				}
			});

			// console.log(this.repairTimeData);
		}
	}
}
</script>

<style>

</style>
