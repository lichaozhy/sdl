<template>
	<div>
		<b-breadcrumb
			:items="[
				{ text: '管理', active: true },
				{ text: '漏洞修复时长', active: true },
			]"
		/>

		<chart-canvas
			style="height:800px"
			:options="{
				credits: { enabled: false },
				series: [{
					type: 'treemap',
					layoutAlgorithm: 'stripes',
					alternateStartingDirection: true,
					levels: [{
						level: 1,
						layoutAlgorithm: 'sliceAndDice',
						dataLabels: {
							enabled: true,
							align: 'left',
							verticalAlign: 'top',
							style: {
								fontSize: '15px',
								fontWeight: 'bold'
							}
						}
					}],
					data: repairTimeData
				}],
				title: {
					text: null
				}
			}"
		/>

		<b-table
			bordered
			small
			striped
			overflow:hidden
			id="admin-overview-table"
			:items="renderData"
			:per-page="perPage"
			:current-page="currentPage"
			class="text-center overview-table"
			:fields="[
				{ key: 'general', label: '总属' },
				{ key: 'branch', label: '分属' },
				{ key: 'projectName', label: '项目名称' },
				{ key: 'projectGroup', label: '项目组' },
				{ key: 'vulnerabilityName', label: '漏洞名称' },
				{ key: 'level', label: '危害级别' },
				{ key: 'status', label: '修复情况' },
				{ key: 'repairTime', label: '平均修复时长' },
			]"
		>
			<template
				slot="repairTime"
				slot-scope="data"
			>{{ data.item.averageRepairTime }}个工作日</template>
		</b-table>

		<div class="mt-3">
			<b-pagination 
				v-model="currentPage" 
				:total-rows="rows" 
				align="center"
				:per-page="perPage"
				aria-controls="admin-overview-table"
			></b-pagination>
		</div>
	</div>
</template>

<script>
import bocData from '../../../../../plugin/backend/boc.json';

const REPAIR_TIME_MAPPING = {
	1: 'A',
	2: 'B',
	3: 'C',
	4: 'D',
	5: 'E',
	6: 'F',
	7: 'G',
	8: 'H',
};

export default {
	data() {
		return {
			bocData,
			repairTimeData: [{
				id: 'A',
				name: '1工作日',
				color: '#FF704B'
			}, {
				id: 'B',
				name: '2工作日',
				color: '#FFA96D'
			}, {
				id: 'C',
				name: '3工作日',
				color: '#FFEB99'
			}, {
			}, {
				id: 'D',
				name: '4工作日',
				color: '#AAE7B0'
			}, {
			}, {
				id: 'E',
				name: '5工作日',
				color: '#84E1E5'
			}, {
			}, {
				id: 'F',
				name: '6工作日',
				color: '#E4D5F6'
			}, {
			}, {
				id: 'G',
				name: '7工作日',
				color: '#8BCBEA'
			}, {
			}, {
				id: 'H',
				name: '8工作日',
				color: '#F6A4EB'
			}],
			perPage: 6,
			currentPage: 1,
		}
	},
	computed: {
		renderData() {
			let clone = this.bocData.slice(0);

			return clone.sort((a, b) => {
				return a.averageRepairTime - b.averageRepairTime;
			});
		},
		rows() {
			return this.renderData.length;
		}		
	},
	created() {
		this.getRepairTimeData();
	},
	methods: {
		getRepairTimeData() {
			let add = true;

			this.bocData.forEach(bocEle => {
				const repairTimeEven = this.repairTimeData.some(timeEle => {
					return timeEle.name === bocEle.branch;
				});

				if (!repairTimeEven) {
					this.repairTimeData.push({
						name: bocEle.branch,
						parent: REPAIR_TIME_MAPPING[bocEle.averageRepairTime],
						value: 1
					});
				} else {
					this.repairTimeData.forEach((timeEle, timeIndex) => {
						if (timeEle.name === bocEle.branch && timeEle.parent === REPAIR_TIME_MAPPING[bocEle.averageRepairTime]) {
							timeEle.value++;
							add = false;
							return;
						}
					});

					if (add) {
						this.repairTimeData.push({
							name: bocEle.branch,
							parent: REPAIR_TIME_MAPPING[bocEle.averageRepairTime],
							value: 1
						});
					}
					add = true;
				}
			});

			console.log(this.repairTimeData);
		}
	}
}
</script>

<style>

</style>
