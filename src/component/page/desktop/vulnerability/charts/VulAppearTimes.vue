<template>
	<div>
		<b-breadcrumb
			:items="[
				{ text: '管理', active: true },
				{ text: '漏洞出现频率', active: true },
			]"
		/>

		<chart-canvas
			style="height:420px"
			:options="{
				credits: { enabled: false },
				chart: {
					type: 'bar'
				},
				title: {
					text: null
				},
				xAxis: {
					title: {
						text: '漏洞名称'
					},
					categories: vulList
				},
				yAxis: {
					min: 0,
					title: {
						text: '记录数'
					}
				},
				legend: {
					reversed: true 
				},
				plotOptions: {
					series: {
						stacking: 'normal'
					}
				},
				series: series
			}"
		/>

		<b-table
			bordered
			small
			striped
			overflow:hidden
			id="admin-overview-table"
			:items="renderData"
			:per-page="perPage"
			:current-page="currentPage"
			class="text-center overview-table"
			:fields="[
				{ key: 'general', label: '总属' },
				{ key: 'branch', label: '分属' },
				{ key: 'projectName', label: '项目名称' },
				{ key: 'projectGroup', label: '项目组' },
				{ key: 'vulnerabilityName', label: '漏洞名称' },
				{ key: 'batch', label: '批次' },
				{ key: 'level', label: '危害级别' },
				{ key: 'status', label: '修复情况' },
			]"
		>
			<template
				slot="repairTime"
				slot-scope="data"
			>{{ data.item.averageRepairTime }}个工作日</template>
		</b-table>

		<div class="mt-3">
			<b-pagination 
				v-model="currentPage" 
				:total-rows="rows" 
				align="center"
				:per-page="perPage"
				aria-controls="admin-overview-table"
			></b-pagination>
		</div>
	</div>
</template>

<script>
import bocData from '../../../../../plugin/backend/boc.json';

export default {
	data() {
		return {
			bocData,
			vulInfo: [],
			vulList: [],
			series: [],
			perPage: 8,
			currentPage: 1,
		}
	},
	computed: {
		renderData() {
			let clone = this.bocData.slice(0);

			const data = clone.filter(boc => {
				return this.vulList.includes(boc.vulnerabilityName);
			});

			return data.sort((a, b) => {
				return a.batch - b.batch;
			});
		},
		rows() {
			return this.renderData.length;
		}		
	},
	created() {
		this.getVulInfo();
		this.getVulList();
		this.getSeries();
	},
	methods: {
		getVulInfo() {
			this.bocData.forEach(bocEle => {
				const vulEven = this.vulInfo.some(vulEle => {
					return vulEle.name === bocEle.vulnerabilityName;
				});

				if (!vulEven) {
					this.vulInfo.push({
						name: bocEle.vulnerabilityName,
						vul: 1,
						batch: [{
							name: bocEle.batch,
							vul: 1
						}]
					});
				} else {
					this.vulInfo.forEach(vulEle => {
						if (vulEle.name === bocEle.vulnerabilityName) {
							vulEle.vul++;

							const batchEven = vulEle.batch.some(batchEle => {
								return batchEle.name === bocEle.batch;
							});

							if (!batchEven) {
								vulEle.batch.push({
									name: bocEle.batch,
									vul: 1
								});
							} else {
								vulEle.batch.forEach(batchEle => {
									if (batchEle.name === bocEle.batch) {
										batchEle.vul++;
									}
								});
							}
						}
					});
				}
			});

			this.vulInfo.sort((a, b) => {
				return b.vul - a.vul;
			});

			this.vulInfo.splice(10);
			// console.log(this.vulInfo);
		},
		getVulList() {
			this.vulList = this.vulInfo.map(vulEle => {
				return vulEle.name;
			});
			// console.log(this.vulList);
		},
		getSeries() {
			this.vulInfo.forEach((vulEle, vulIndex) => {
				vulEle.batch.forEach((batchEle) => {
					const even = this.series.some(serie => {
						return serie.name === batchEle.name;
					});

					if (!even) {
						this.series.push({
							name: batchEle.name,
							data:[0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
						});

						this.series[this.series.length - 1].data[vulIndex] += batchEle.vul;
					} else {
						this.series.forEach(serie => {
							if (serie.name === batchEle.name) {
								serie.data[vulIndex] += batchEle.vul;
							}
						});
					}
				});
			});

			this.series.sort((a, b) => {
				return b.name - a.name;
			})
			// console.log(this.series);
		}
	}
}
</script>

<style>

</style>
