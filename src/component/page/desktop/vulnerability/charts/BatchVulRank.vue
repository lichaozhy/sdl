<template>
	<div>
		<b-breadcrumb
			:items="[
				{ text: '管理', active: true },
				{ text: '批次漏洞排名', active: true },
			]"
		/>

		<chart-canvas
			style="height:300px"
			:options="{
				credits: { enabled: false },
				chart: {
					type: 'bar'
				},
				title: {
					text: null
				},
				xAxis: {
					title: {
						text: '批次'
					},
					categories: batchList
				},
				yAxis: {
					min: 0,
					title: {
						text: '记录数'
					}
				},
				legend: {
					reversed: true 
				},
				plotOptions: {
					series: {
						stacking: 'normal'
					}
				},
				series: series
			}"
		/>

		<b-table
			bordered
			small
			striped
			overflow:hidden
			id="admin-overview-table"
			:items="bocData"
			:per-page="perPage"
      :current-page="currentPage"
			class="text-center overview-table"
			:fields="[
				{ key: 'general', label: '总属' },
				{ key: 'branch', label: '分属' },
				{ key: 'projectName', label: '项目名称' },
				{ key: 'projectGroup', label: '项目组' },
				{ key: 'vulnerabilityName', label: '漏洞名称' },
				{ key: 'level', label: '危害级别' },
				{ key: 'status', label: '修复情况' },
				{ key: 'developer', label: '开发' },
				{ key: 'show_details', label: '' },
			]"
		>
			<template slot="show_details" slot-scope="row">
				<b-button size="sm"
					@click="row.toggleDetails"
				>{{ row.detailsShowing ? '隐藏' : '显示'}}详情</b-button>
			</template>

			<template slot="row-details" slot-scope="row">
				<span>版本:&nbsp;{{ row.item.version }}</span>
				<span class="ml-5">漏洞录入时间:&nbsp;{{ format(row.item.vulnerabilityEntryTime) }}</span>
				<span class="ml-5">漏洞编号:&nbsp;{{ row.item.vulnerabilityNumber }}</span>
				<span class="ml-5">漏洞复测时间:&nbsp;{{ format(row.item.vulnerabilityRetestTime) }}</span>
				<span class="ml-5">漏洞修复时间:&nbsp;{{ format(row.item.vulnerabilityRepairTime) }}</span>
			</template>
			
			<template
				slot="repairTime"
				slot-scope="data"
			>{{ data.item.averageRepairTime }}个工作日</template>
		</b-table>

		<div class="mt-3">
			<b-pagination 
				v-model="currentPage" 
				:total-rows="rows" 
				align="center"
				:per-page="perPage"
				aria-controls="admin-overview-table"
			></b-pagination>
		</div>
	</div>
</template>

<script>
import bocData from '../../../../../plugin/backend/boc.json';

export default {
	data() {
		return {
			bocData,
			batchInfo: [],
			batchList: [],
			series: [],
			perPage: 9,
			currentPage: 1,
		}
	},
	computed: {
		rows() {
			return this.bocData.length;
		}		
	},
	created() {
		this.getBatchInfo();
		this.getBatchList();
		this.getSeries();
	},
	methods: {
		getBatchInfo() {
			this.bocData.forEach(bocEle => {
				const batchEven = this.batchInfo.some(batchEle => {
					return batchEle.batch === bocEle.batch;
				});

				if (!batchEven) {
					this.batchInfo.push({
						batch: bocEle.batch,
						vul: 1,
						branch: [{
							name: bocEle.branch,
							vul: 1
						}]
					});
				} else {
					this.batchInfo.forEach(batchEle => {
						if (batchEle.batch === bocEle.batch) {
							batchEle.vul++;

							const branchEven = batchEle.branch.some(branchEle => {
								return branchEle.name === bocEle.branch;
							})

							if (!branchEven) {
								batchEle.branch.push({
									name: bocEle.branch,
									vul: 1
								});
							} else {
								batchEle.branch.forEach(branchEle => {
									if (branchEle.name === bocEle.branch) {
										branchEle.vul++;
									}
								});
							}
						}
					});
				}
			});

			this.batchInfo.sort((a, b) => {
				return b.vul - a.vul;
			});

			this.batchInfo.splice(10);
			// console.log(this.batchInfo);
		},
		getBatchList() {
			this.batchList = this.batchInfo.map(batchEle => {
				return batchEle.batch;
			});
		},
		getSeries() {
			this.batchInfo.forEach((batchEle, batchIndex) => {
				batchEle.branch.forEach((branchEle) => {
					const even = this.series.some(serie => {
						return serie.name === branchEle.name;
					});

					if (!even) {
						this.series.push({
							name: branchEle.name,
							data:[0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
						});

						this.series[this.series.length - 1].data[batchIndex] += branchEle.vul;
					} else {
						this.series.forEach(serie => {
							if (serie.name === branchEle.name) {
								serie.data[batchIndex] += branchEle.vul;
							}
						});
					}
				});
			});

			// console.log(this.series);
		}
	}
}
</script>

<style>

</style>
