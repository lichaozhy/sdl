<template>
	<div>
		<b-breadcrumb
			:items="[
				{ text: '管理', active: true },
				{ text: '项目组漏洞排名', active: true },
			]"
		/>

		<chart-canvas
			style="height:420px"
			:options="{
				credits: { enabled: false },
				chart: { type: 'bar' },
				title: { text: null },
				xAxis: {
					categories: groupList,
					title: {
						text: '项目组'
					}
				},
				yAxis: {
					min: 0,
					title: {
						text: '记录数',
					}
				},
				plotOptions: {
					bar: {
						dataLabels: {
							enabled: true,
						}
					}
				},
				legend: false,
				series: [{
					colorByPoint: true,
					data: [
						{ y: groupInfo[0].vul },
						{ y: groupInfo[1].vul },
						{ y: groupInfo[2].vul },
						{ y: groupInfo[3].vul },
						{ y: groupInfo[4].vul },
						{ y: groupInfo[5].vul },
						{ y: groupInfo[6].vul },
						{ y: groupInfo[7].vul }
					]
				}]
			}"
		/>

		<b-table
			bordered
			small
			striped
			overflow:hidden
			id="admin-overview-table"
			:items="renderData"
			:per-page="perPage"
      :current-page="currentPage"
			class="text-center overview-table"
			:fields="[
				{ key: 'general', label: '总属' },
				{ key: 'branch', label: '分属' },
				{ key: 'projectName', label: '项目名称' },
				{ key: 'projectGroup', label: '项目组' },
				{ key: 'vulnerabilityName', label: '漏洞名称' },
				{ key: 'vulnerabilityNumber', label: '漏洞编号' },
				{ key: 'level', label: '危害级别' },
				{ key: 'status', label: '修复情况' },
			]"
		>
			<!-- <template slot="show_details" slot-scope="row">
				<b-button size="sm"
					@click="row.toggleDetails"
				>{{ row.detailsShowing ? '隐藏' : '显示'}}详情</b-button>
			</template> -->

			<!-- <template slot="row-details" slot-scope="row">
				<span>版本:&nbsp;{{ row.item.version }}</span>
				<span class="ml-5">漏洞录入时间:&nbsp;{{ format(row.item.vulnerabilityEntryTime) }}</span>
				<span class="ml-5">漏洞编号:&nbsp;{{ row.item.vulnerabilityNumber }}</span>
				<span class="ml-5">漏洞复测时间:&nbsp;{{ format(row.item.vulnerabilityRetestTime) }}</span>
				<span class="ml-5">漏洞修复时间:&nbsp;{{ format(row.item.vulnerabilityRepairTime) }}</span>
			</template> -->
			
			<template
				slot="repairTime"
				slot-scope="data"
			>{{ data.item.averageRepairTime }}个工作日</template>
		</b-table>

		<div class="mt-3">
			<b-pagination 
				v-model="currentPage" 
				:total-rows="rows" 
				align="center"
				:per-page="perPage"
				aria-controls="admin-overview-table"
			></b-pagination>
		</div>
		
	</div>
</template>

<script>
import bocData from '../../../../../plugin/backend/boc.json';

const GROUP_MAPPING = {
	'软开中心': 0,
	'开发一部': 1,
	'开发二部': 2,
	'开发三部': 3,
	'开发四部': 4,
	'开发五部': 5,
	'开发六部': 6,
	'开发七部': 7,
	'开发八部': 8,
	'开发九部': 9,
	'开发十部': 10,
};

export default {
	data() {
		return {
			bocData,
			groupInfo: [],
			groupList: [],
			perPage: 8,
			currentPage: 1,
		}
	},
	computed: {
		renderData() {
			let clone = this.bocData.slice(0);
			return clone.sort((a, b) => {
				return GROUP_MAPPING[a.projectGroup] - GROUP_MAPPING[b.projectGroup];
			});
		},
		rows() {
			return this.bocData.length;
		}		
	},
	created() {
		this.getgroupInfo();
		this.getGroupList();
	},
	methods: {
		getgroupInfo() {
			this.bocData.forEach(bocEle => {
				const even = this.groupInfo.some(group => {
					return group.name === bocEle.projectGroup;
				});

				if (!even) {
					this.groupInfo.push({
						name: bocEle.projectGroup,
						vul: 1
					});
				} else {
					this.groupInfo.forEach(group => {
						if (group.name === bocEle.projectGroup) {
							group.vul++;
						}
					});
				}
			});

			this.groupInfo.sort((a, b) => {
				return b.vul - a.vul;
			});

			console.log(this.groupInfo);
		},
		getGroupList() {
			this.groupList = this.groupInfo.map(group => {
				return group.name;
			});
		}
	}
}
</script>

<style>

</style>
