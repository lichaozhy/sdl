<template>
  <div>
    <b-breadcrumb
			:items="[
				{ text: '管理', active: true },
				{ text: '项目漏洞排名', active: true },
			]"
		/>

    <chart-canvas
      style="height:420px"
      :options="{
				credits: { enabled: false },
        chart: {
          type: 'bar'
        },
        title: {
          text: null
        },
        xAxis: {
          title: {
            text: '项目(系统)名称'
          },
          categories: projectList
        },
        yAxis: {
          min: 0,
          title: {
            text: '记录数'
          }
        },
        legend: {
          reversed: true 
        },
        plotOptions: {
          series: {
            stacking: 'normal'
          }
        },
        series: series
      }"
    />

    <b-table
			bordered
			small
			striped
			overflow:hidden
			id="admin-overview-table"
			:items="renderData"
			:per-page="perPage"
      :current-page="currentPage"
			class="text-center overview-table"
			:fields="[
				{ key: 'general', label: '总属' },
				{ key: 'branch', label: '分属' },
				{ key: 'projectName', label: '项目名称' },
				{ key: 'projectGroup', label: '项目组' },
				{ key: 'vulnerabilityName', label: '漏洞名称' },
				{ key: 'level', label: '危害级别' },
				{ key: 'status', label: '修复情况' },
				{ key: 'developer', label: '开发' },
			]"
		>
			<template
				slot="repairTime"
				slot-scope="data"
			>{{ data.item.averageRepairTime }}个工作日</template>
		</b-table>

		<div class="mt-3">
			<b-pagination 
				v-model="currentPage" 
				:total-rows="rows" 
				align="center"
				:per-page="perPage"
				aria-controls="admin-overview-table"
			></b-pagination>
		</div>
  </div>
</template>

<script>
import bocData from '../../../../../plugin/backend/boc.json';

export default {
	data() {
		return {
			bocData,
			projectInfo: [],
			projectList: [],
			series: [{
				name: '高危漏洞',
				data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
			}, {
				name: '中危漏洞',
				data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
			}, {
				name: '低危漏洞',
				data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
			}, {
				name: '建议修复',
				data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
			}],
			perPage: 8,
			currentPage: 1,
		}
	},
	computed: {
		renderData() {
			let clone = this.bocData.slice(0);

			return clone.filter(boc => {
				return this.projectList.includes(boc.projectName);
			});

			// return data.sort((a, b) => {
			// 	return a.batch - b.batch;
			// });
		},
		rows() {
			return this.renderData.length;
		}		
	},
	created() {
		this.getProjectInfo();
		this.getProjectList();
		this.getSeries();
	},
	methods: {
		getProjectInfo() {
			this.bocData.forEach(bocEle => {
				const projectNameEven = this.projectInfo.some(projectNameEle => {
					return projectNameEle.projectName === bocEle.projectName;
				});

				if (!projectNameEven) {
					this.projectInfo.push({
						projectName: bocEle.projectName,
						vul: 1,
						level: [{
							name: '建议修复',
							vul: 0
						},{
							name: '低危漏洞',
							vul: 0
						},{
							name: '中危漏洞',
							vul: 0
						},{
							name: '高危漏洞',
							vul: 0
						}]
					});
					this.projectInfo[this.projectInfo.length - 1].level.forEach(lvEle => {
						if (lvEle.name === bocEle.level) {
							lvEle.vul++;
						}
					});
				} else {
					this.projectInfo.forEach(projectNameEle => {
						if (projectNameEle.projectName === bocEle.projectName) {
							projectNameEle.vul++;

							projectNameEle.level.forEach(lvEle => {
								if (lvEle.name === bocEle.level) {
									lvEle.vul++;
								}
							});
						}
					});
				}
			});

			this.projectInfo.sort((a, b) => {
				return b.vul - a.vul;
			});

			this.projectInfo.splice(10);
			// console.log(this.projectInfo);
		},
		getProjectList() {
			this.projectList = this.projectInfo.map(projectEle => {
				return projectEle.projectName;
			});
			// console.log(this.projectList);
		},
		getSeries() {
			this.projectInfo.forEach((projectEle, projectIndex) => {
				projectEle.level.forEach((lvEle) => {

					this.series.forEach(serie => {
						if (serie.name === lvEle.name) {
							serie.data[projectIndex] += lvEle.vul;
						}
					});
				});
			});
		}
	}
}
</script>

<style>

</style>
