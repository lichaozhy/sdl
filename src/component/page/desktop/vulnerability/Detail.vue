<template>
	
<div class="vulnerability-detail">
	<b-breadcrumb
		:items="[
			{ text: '漏洞', active: true },
			{ text: '漏洞列表', href: '#/desktop/vulnerability/overview' },
			{ text: '漏洞详情', active: true },
		]"
	/>

	<h4 class="mt-3">漏洞基本信息</h4>
	<div>
		<b-row>
			<b-col>
				<b-form-group label="漏洞名称">
					<b-form-input size="sm" value="不安全的HTTP方法"></b-form-input>
				</b-form-group>
			</b-col>
			<b-col>
				<b-form-group label="漏洞编号">
					<b-form-input value="BOC-201810-0061	" size="sm"></b-form-input>
				</b-form-group>
			</b-col>
			<b-col>
				<b-form-group label="项目名称">
					<b-form-input value="移动催收系统" size="sm"></b-form-input>
				</b-form-group>
			</b-col>
		</b-row>
		<b-row>
			<b-col>
				<b-form-group label="总署">
					<b-form-input value="事业部" size="sm"></b-form-input>
				</b-form-group>
			</b-col>
			<b-col>
				<b-form-group label="分属">
					<b-form-input value="信用卡中心" size="sm"></b-form-input>
				</b-form-group>
			</b-col>
			<b-col>
				<b-form-group label="项目组">
					<b-form-input size="sm" value="开发一部"></b-form-input>
				</b-form-group>
			</b-col>
		</b-row>
		<b-row>
			<b-col>
				<b-form-group label="危险级别">
					<b-form-input value="低危漏洞" size="sm"></b-form-input>
				</b-form-group>
			</b-col>
			<b-col>
				<b-form-group label="风险值">
					<b-form-input value="3" size="sm"></b-form-input>
				</b-form-group>
			</b-col>
			<b-col>
				<b-form-group label="批次">
					<b-form-input size="sm" value="32"></b-form-input>
				</b-form-group>
			</b-col>
		</b-row>
	</div>

	<h3 class="mt-3" style="display:inline-block;">生命周期</h3>
	<b-button
		size="sm"
		variant="info"
		class="ml-4"
		style="margin-bottom:10px;"
		@click="showModal('vul-add-modal')"
	><i
		class="fas fa-plus mr-2"
	/>添加漏洞</b-button>
	<b-button
		size="sm"
		variant="primary"
		class="ml-4"
		style="margin-bottom:10px;"
		@click="showModal('vul-add-batch-modal')"
	><i
		class="fas fa-plus mr-2"
	/>批量导入</b-button>

	<div id="stage-track">
		<div id="stage-track-wrap" class="border h-100">
			<b-table
				small
				bordered
				class="w-auto mb-0"
				:fields="[
					{ key: 'requirement', label: '发现阶段' },
					{ key: 'design', label: '评估阶段' },
					{ key: 'development', label: '创建漏洞修复阶段' },
					{ key: 'testing', label: '复测阶段' },
					{ key: 'acceptance', label: '归档阶段' },
				]"
			>
				<template slot="bottom-row">
					<td>
						<b-card
							border-variant="primary"
							no-body
							style="min-height:365px;"
						>
							<b-card-header
								class="py-1 px-2 rounded-0"
								header-bg-variant="primary"
								header-text-variant="light"
							>
								<strong class="mr-2">漏洞信息</strong>
							</b-card-header>

							<b-card-text class="p-2 m-0">
								<b-form-group label="漏洞名称:">
									<b-form-input value="不安全的HTTP方法" size="sm" readonly></b-form-input>
								</b-form-group>
								<b-form-group label="发现日期:">
									<b-form-input value="2017/10/04" size="sm" readonly></b-form-input>
								</b-form-group>
								<b-form-group label="提交人:">
									<b-form-input value="张三" size="sm" readonly></b-form-input>
								</b-form-group>
								<b-form-group label="版本:">
									<b-form-input value="v3.0" size="sm" readonly></b-form-input>
								</b-form-group>
							</b-card-text>
						</b-card>
					</td>

					<td>
						<b-card
							border-variant="primary"
							no-body
							style="min-height:365px;"
						>
							<b-card-header
								class="py-1 px-2 rounded-0"
								header-bg-variant="primary"
								header-text-variant="light"
							>
								<strong class="mr-2">评估</strong>
							</b-card-header>

							<b-card-text class="p-2 m-0">
								<!-- <b-form-group label="绝对条件:">
									<b-form-radio name="some-radios" value="A">内部物理隔离的核心系统</b-form-radio>
									<b-form-radio name="some-radios" value="B">即将下线的系统</b-form-radio>
									<b-form-radio name="some-radios" value="C">业内严重漏洞</b-form-radio>
									<b-form-radio name="some-radios" value="D">外部可利用高危漏洞</b-form-radio>
								</b-form-group> -->

								<b-form-group label="绝对条件:">
									<b-form-checkbox-group
										:options="[{
											text: '内部物理隔离的核心系统', value: 'A'
										}, {
											text: '即将下线的系统', value: 'B'
										}, {
											text: '业内严重漏洞', value: 'C'
										}, {
											text: '外部可利用高危漏洞', value: 'D'
										}]"
										name="a"
										stacked
									></b-form-checkbox-group>
								</b-form-group>

								<!-- <b-form-group label="权重评估:">
									<b-form-radio name="some-radio" value="E">漏洞热度</b-form-radio>
									<b-form-radio name="some-radio" value="F">POC</b-form-radio>
									<b-form-radio name="some-radio" value="G">资产重要性</b-form-radio>
									<b-form-radio name="some-radio" value="H">资产暴露情况</b-form-radio>
									<b-form-radio name="some-radio" value="I">已有防护措施</b-form-radio>
								</b-form-group> -->
								
								<b-form-group label="权重评估:">
									<b-form-checkbox-group
										:options="[{
											text: '漏洞热度', value: 'E'
										}, {
											text: 'POC', value: 'F'
										}, {
											text: '资产重要性', value: 'G'
										}, {
											text: '资产暴露情况', value: 'H'
										}, {
											text: '已有防护措施', value: 'I'
										}]"
										name="b"
										stacked
									></b-form-checkbox-group>
								</b-form-group>
							</b-card-text>
						</b-card>
					</td>

					<td>
						<b-card
							border-variant="primary"
							no-body
							style="min-height:365px;"
						>
							<b-card-header
								class="py-1 px-2 rounded-0"
								header-bg-variant="primary"
								header-text-variant="light"
							>
								<strong class="mr-2">创建</strong>
							</b-card-header>

							<b-card-text class="p-2 m-0">
								<b-form-group label="漏洞名称:">
									<b-form-input value="不安全的HTTP方法" size="sm" readonly></b-form-input>
								</b-form-group>
								<b-form-group label="分值:">
									<b-form-input value="7" size="sm" readonly></b-form-input>
								</b-form-group>
								<b-form-group label="方案:">
									<b-form-file
										v-model="file"
										:state="Boolean(file)"
										placeholder="选择文件或将文件拖拽至此..."
										drop-placeholder="拖拽至此..."
									></b-form-file>
								</b-form-group>
							</b-card-text>
						</b-card>
					</td>
					<td>
						<b-card
							border-variant="primary"
							no-body
							style="min-height:365px;"
						>
							<b-card-header
								class="py-1 px-2 rounded-0"
								header-bg-variant="primary"
								header-text-variant="light"
							>
								<strong class="mr-2">验证POC</strong>
							</b-card-header>

							<b-card-text class="p-2 m-0">
								<b-button class="mt-2" variant="primary" block>通过</b-button>
								<b-button class="mt-3 mb-2" variant="warning" block>未通过</b-button>

								<b-form-group label="报告:">
									<b-button variant="link">点击下载</b-button>
								</b-form-group>
							</b-card-text>
						</b-card>
					</td>
					<td>
						<b-card
							border-variant="primary"
							no-body
							style="min-height:365px;"
						>
							<b-card-header
								class="py-1 px-2 rounded-0"
								header-bg-variant="primary"
								header-text-variant="light"
							>
								<strong class="mr-2">归档信息</strong>
							</b-card-header>

							<b-card-text class="p-2 m-0">
								<b-form-group label="漏洞名称:">
									<b-form-input value="不安全的HTTP方法" size="sm" readonly></b-form-input>
								</b-form-group>
								<b-form-group label="归档日期:">
									<b-form-input value="2017/10/04" size="sm" readonly></b-form-input>
								</b-form-group>
								<b-form-group label="归档人:">
									<b-form-input value="张三" size="sm" readonly></b-form-input>
								</b-form-group>
							</b-card-text>
						</b-card>
					</td>
				</template>
			</b-table>
		</div>
		<b-modal ref="vul-add-modal" scrollable hide-footer title="添加漏洞">
			<div>
				<b-form-group 
					v-for="(option, index) in vulAddModalOptions"
					:key="index"
					label-cols="2" 
					label-size="sm" 
					:label="option.label"
				>
					<b-form-input
						v-if="option.type === 'input'"
						size="sm" 
						v-model="vulAdd[option.vModel]"
					></b-form-input>

					<b-form-select
						v-if="option.type === 'select'"
						size="sm"
						v-model="vulAdd[option.vModel]"
						:options="option.selectOptions"
					></b-form-select>
				</b-form-group>
			</div>
			<b-button class="mt-3" variant="primary" block @click="vulAddSubmit('vul-add-modal')">添加</b-button>
			<b-button class="mt-2" variant="warning" block @click="vulAddClose('vul-add-modal')">关闭并清除填入信息</b-button>
		</b-modal>
		<b-modal ref="vul-add-batch-modal" scrollable hide-footer title="批量导入">
			<div>
				<b-form-group label="请上传CSV文件:">
					<b-form-file
						v-model="file"
						:state="Boolean(file)"
						placeholder="选择文件或将文件拖拽至此..."
						drop-placeholder="拖拽至此..."
					></b-form-file>
				</b-form-group>
			</div>
			<b-button class="mt-3" variant="primary" block @click="vulAddSubmit('vul-add-batch-modal')">导入</b-button>
		</b-modal>
	</div>
</div>

</template>

<script>
export default {
	data() {
		return {
			file: '',
			vulAddModalOptions: [
				{ label: '总署', vModel: 'general', type: 'input' },
				{ label: '分属', vModel: 'branch', type: 'input' },
				{ label: '项目名称', vModel: 'projectName', type: 'input' },
				{ label: '项目组', vModel: 'projectGroup', type: 'input' },
				{ label: '漏洞名称', vModel: 'vulnerabilityName', type: 'input' },
				{ label: '漏洞编号', vModel: 'vulnerabilityNumber', type: 'input' },
				{ label: '危害等级', vModel: 'level', type: 'select', selectOptions: [
					{ value: '低危漏洞', text:'低危漏洞' },
					{ value: '中危漏洞', text:'中危漏洞' },
					{ value: '高危漏洞', text:'高危漏洞' },
					{ value: '建议修复', text:'建议修复' }
				]},
				{ label: '修复情况', vModel: 'status', type: 'select', selectOptions: [
					{ value: '已修复', text:'已修复' },
					{ value: '未修复', text:'未修复' },
					{ value: '建议修复', text:'建议修复' },
					{ value: '忽略', text:'忽略' }
				]},
				{ label: '版本', vModel: 'version', type: 'input' },
				{ label: '批次', vModel: 'batch', type: 'input' },
				{ label: '开发', vModel: 'developer', type: 'input' },
				{ label: '系统类型', vModel: 'systemStyle', type: 'select', selectOptions: [
					{ value: 'A系统类型', text: 'A系统类型' },
					{ value: 'B系统类型', text: 'B系统类型' }
				]},
				{ label: '系统名称', vModel: 'systemName', type: 'input' },
				{ label: '工单名称', vModel: 'orderName', type: 'input' },
				{ label: '环境', vModel: 'environment', type: 'input' },
				{ label: '资产', vModel: 'assets', type: 'input' },
				{ label: '验证指引', vModel: 'verification', type: 'input' },
				{ label: '风险值', vModel: 'risk', type: 'input' },
				{ label: '漏洞类型', vModel: 'vulnerabilityStyle', type: 'input' },
				{ label: '测试人', vModel: 'tester', type: 'input' },
				{ label: '处理状态', vModel: 'processStatus', type: 'select', selectOptions: [
					{ value: '未处理', text: '未处理' },
					{ value: '已加固', text: '已加固' },
					{ value: '已接受', text: '已接受' },
					{ value: '误报', text: '误报' }
				]},
				{ label: '复测状态', vModel: 'retestStatus', type: 'select', selectOptions:[
					{ value: '未复测', text: '未复测' },
					{ value: '复测成功', text: '复测成功' },
					{ value: '复测失败', text: '复测失败' }
				]},
				{ label: '平均修复时间', vModel: 'averageRepairTime', type: 'input' },
				{ label: '新增事件', vModel: 'newEvent', type: 'input' },
			],
			vulAdd: {}
		};
	},
	mounted() {
		this.vulAddInit();
	},
	methods: {
		vulAddInit() {
			this.vulAdd = {
				'general': '',
				'branch': '',
				'projectName': '', 
				'projectGroup': '',
				'vulnerabilityName': '',
				'vulnerabilityEntryTime': '2017-10-03T16:00:00.000Z',
				'vulnerabilityNumber': '',
				'level': '低危漏洞',
				'status': '已修复',
				'version': 'v1.0.0',
				'batch': '1',
				'developer': '',
				'vulnerabilityRetestTime': '2017-10-03T16:00:00.000Z',
				'vulnerabilityRepairTime': '2017-10-03T16:00:00.000Z',
				'averageRepairTime': '0',
				'systemStyle': 'A系统类型',
				'systemName': '',
				'orderName': '',
				'environment': '',
				'assets': '',
				'verification': '',
				'risk': '0',
				'vulnerabilityStyle': '',
				'tester': '',
				'processStatus': '未处理',
				'retestStatus': '未复测',
				'newEvent': '',
				'overdue': ''
			};
		},
		showModal(ref) {
			this.$refs[ref].show();
		},
		vulAddSubmit(ref) {
			this.$refs[ref].hide();
		},
		vulAddClose(ref) {
			this.vulAddInit();
			this.$refs[ref].hide();
		}
	}
};
</script>

<style lang="scss">
.vulnerability-detail {
	.project-icon .btn-lg {
		position: relative;

		i {
			font-size: 36px;
		}

		.badge {
			font-size: 12px;
			position: absolute;
			top: 0;
			right: 0;
		}
	}

	#stage-track {
		#stage-track-wrap {
			overflow-x: scroll;
			background-color: #f6f6f6;
		}

		height: 437px;

		&.full {
			padding: 15px;
			background: #fff;
			position: fixed;
			height: 100%;
			width: 100%;
			top: 0;
			left: 0;

			table tbody {
				height: 96%;
			}
		}
	}

	table {
		height: 100%;
		background: #fff;

		thead {
			display:table;
			width:100%;
			table-layout:fixed;
			width: calc( 100% - 16px )
		}

		tbody {
			display: block;
			height: 377px;
			overflow-y: scroll;
		}

		th {
			text-align: center;
		}

		td {
			padding: 5px;

			> div {
				width: 360px;
				// height: 100%;
				// padding: 5px;
				// overflow-y: scroll;
			}
		}
	}
}
</style>