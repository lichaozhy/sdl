<template>
	
<div class="admin-overview">
	<b-breadcrumb
			:items="[
				{ text: '漏洞', active: true },
				{ text: '漏洞详情列表', active: true }
			]"
		/>

		<h3 class="mt-3">漏洞分布</h3>
		<b-card-group>
			<b-card no-body>
				<chart-canvas
					style="height:200px"
					:options="{
						credits: { enabled: false },
						chart: { type: 'pie' },
						title: { text: null },
						plotOptions: {
							pie: {
								allowPointSelect: true,
								cursor: 'pointer',
								dataLabels: { enabled: false },
								showInLegend: true
							}
						},
						series: [{
							name: '数量',
							colorByPoint: true,
							data: [
								{ name: '高危', y: 35 },
								{ name: '中危', y: 214 },
								{ name: '低危', y: 101 }
							]
						}]
					}"
				/>
				<div slot="header">等级分布</div>
			</b-card>
			<b-card no-body>
				<b-card-text><visual-number value="35" /></b-card-text>
				<div slot="header">高度危险</div>
			</b-card>
			<b-card no-body>
				<b-card-text><visual-number value="214" /></b-card-text>
				<div slot="header">中等危险</div>
			</b-card>
			<b-card no-body>
				<b-card-text><visual-number value="101" /></b-card-text>
				<div slot="header">低等危险</div>
			</b-card>
		</b-card-group>

		<h3 class="mt-3">漏洞列表</h3>

		<b-table
			bordered
			small
			striped
			overflow:hidden
			id="admin-overview-table"
			:items="renderData"
			:per-page="perPage"
      :current-page="currentPage"
			class="text-center overview-table"
			:fields="[
				{ key: 'general', label: '总属' },
				{ key: 'branch', label: '分属' },
				{ key: 'projectName', label: '项目名称' },
				{ key: 'projectGroup', label: '项目组' },
				{ key: 'vulnerabilityName', label: '漏洞名称' },
				{ key: 'level', label: '危害级别' },
				{ key: 'status', label: '修复情况' },
				{ key: 'batch', label: '批次' },
				{ key: 'developer', label: '开发' },
				{ key: 'repairTime', label: '平均修复时间' },
				{ key: 'show_details', label: '' },
			]"
		>
			<template slot="HEAD_general">
				<b-dropdown 
					size="sm"
					text="总属" 
					variant="link"
				>
					<b-form-group class="overview-table-filter">
						<b-form-checkbox
							v-model="general.allSelected"
							style="margin-top:5px;"
							@change="toggleAll(general)"
						>全选</b-form-checkbox>
						<b-form-checkbox-group
							stacked
							v-model="general.selected"
							:options="general.list"
						/>
					</b-form-group>
				</b-dropdown>
			</template>
			
			<template slot="HEAD_branch">
				<b-dropdown 
					size="sm"
					text="分属" 
					variant="link"
				>
					<b-form-group class="overview-table-filter">
						<b-form-checkbox
							v-model="branch.allSelected"
							style="margin-top:5px;"
							@change="toggleAll(branch)"
						>全选</b-form-checkbox>
						<b-form-checkbox-group
							stacked
							v-model="branch.selected"
							:options="branch.list"
						/>
					</b-form-group>
				</b-dropdown>
			</template>

			<template slot="HEAD_projectName">
				<b-dropdown 
					size="sm"
					text="项目名称" 
					variant="link"
				>
					<b-form-group 
						class="overview-table-filter"
					>
						<b-form-checkbox
							v-model="projectName.allSelected"
							style="margin-top:5px;"
							@change="toggleAll(projectName)"
						>全选</b-form-checkbox>
						<b-form-checkbox-group
							stacked
							v-model="projectName.selected"
							:options="projectName.list"
						/>
					</b-form-group>
				</b-dropdown>
			</template>

			<template slot="HEAD_projectGroup">
				<b-dropdown 
					size="sm"
					text="项目组" 
					variant="link"
				>
					<b-form-group class="overview-table-filter">
						<b-form-checkbox
							v-model="projectGroup.allSelected"
							style="margin-top:5px;"
							@change="toggleAll(projectGroup)"
						>全选</b-form-checkbox>
						<b-form-checkbox-group
							stacked
							v-model="projectGroup.selected"
							:options="projectGroup.list"
						/>
					</b-form-group>
				</b-dropdown>
			</template>

			<template slot="HEAD_vulnerabilityName">
				<b-dropdown 
					size="sm"
					text="漏洞名称" 
					variant="link"
				>
					<b-form-group class="overview-table-filter">
						<b-form-checkbox
							v-model="vulnerabilityName.allSelected"
							style="margin-top:5px;"
							@change="toggleAll(vulnerabilityName)"
						>全选</b-form-checkbox>
						<b-form-checkbox-group
							stacked
							v-model="vulnerabilityName.selected"
							:options="vulnerabilityName.list"
						/>
					</b-form-group>
				</b-dropdown>
			</template>

			<template slot="HEAD_level">
				<b-dropdown 
					size="sm"
					text="危害级别" 
					variant="link"
				>
					<b-form-group class="overview-table-filter">
						<b-form-checkbox
							v-model="level.allSelected"
							style="margin-top:5px;"
							@change="toggleAll(level)"
						>全选</b-form-checkbox>
						<b-form-checkbox-group
							stacked
							v-model="level.selected"
							:options="level.list"
						/>
					</b-form-group>
				</b-dropdown>
			</template>

			<template slot="HEAD_status">
				<b-dropdown 
					size="sm"
					text="修复情况" 
					variant="link"
				>
					<b-form-group class="overview-table-filter">
						<b-form-checkbox
							v-model="status.allSelected"
							style="margin-top:5px;"
							@change="toggleAll(status)"
						>全选</b-form-checkbox>
						<b-form-checkbox-group
							stacked
							v-model="status.selected"
							:options="status.list"
						/>
					</b-form-group>
				</b-dropdown>
			</template>

			<template slot="HEAD_batch">
				<b-dropdown 
					size="sm"
					text="批次" 
					variant="link"
				>
					<b-form-group class="overview-table-filter">
						<b-form-checkbox
							v-model="batch.allSelected"
							style="margin-top:5px;"
							@change="toggleAll(batch)"
						>全选</b-form-checkbox>
						<b-form-checkbox-group
							stacked
							v-model="batch.selected"
							:options="batch.list"
						/>
					</b-form-group>
				</b-dropdown>
			</template>

			<template slot="HEAD_developer">
				<b-dropdown 
					size="sm"
					text="开发" 
					variant="link"
				>
					<b-form-group class="overview-table-filter">
						<b-form-checkbox
							v-model="developer.allSelected"
							style="margin-top:5px;"
							@change="toggleAll(developer)"
						>全选</b-form-checkbox>
						<b-form-checkbox-group
							stacked
							v-model="developer.selected"
							:options="developer.list"
						/>
					</b-form-group>
				</b-dropdown>
			</template>

			<template slot="HEAD_repairTime">
				<b-dropdown 
					size="sm"
					text="平均修复时间" 
					variant="link"
					style="float: right"
				>
					<b-form-group class="overview-table-filter">
						<b-form-checkbox
							v-model="repairTime.allSelected"
							style="margin-top:5px;"
							@change="toggleAll(repairTime)"
						>全选</b-form-checkbox>
						<b-form-checkbox-group 
							stacked
							v-model="repairTime.selected"
							:options="repairTime.list"
						/>
					</b-form-group>
				</b-dropdown>
			</template>
			
			<template slot="show_details" slot-scope="row">
				<b-button size="sm"
					@click="row.toggleDetails"
				>{{ row.detailsShowing ? '隐藏' : '显示'}}详情</b-button>
			</template>

			<template slot="row-details" slot-scope="row">
				<span>版本:&nbsp;{{ row.item.version }}</span>
				<span class="ml-5">漏洞录入时间:&nbsp;{{ format(row.item.vulnerabilityEntryTime) }}</span>
				<span class="ml-5">漏洞编号:&nbsp;{{ row.item.vulnerabilityNumber }}</span>
				<span class="ml-5">漏洞复测时间:&nbsp;{{ format(row.item.vulnerabilityRetestTime) }}</span>
				<span class="ml-5">漏洞修复时间:&nbsp;{{ format(row.item.vulnerabilityRepairTime) }}</span>
			</template>
			
			<template
				slot="repairTime"
				slot-scope="data"
			>{{ data.item.averageRepairTime }}个工作日</template>
		</b-table>

		<div class="mt-3">
			<b-pagination 
				v-model="currentPage" 
				:total-rows="rows" 
				align="center"
				:per-page="perPage"
				aria-controls="admin-overview-table"
			></b-pagination>
		</div>
</div>

</template>

<script>
import bocData from '../../../../plugin/backend/boc.json';

export default {
	data() {
		return {
			bocData,
			perPage: 10,
			currentPage: 1,

			general: {
				list: [],
				selected: [],
				allSelected: true,
			},
			branch: {
				list: [],
				selected: [],
				allSelected: true,
			},
			projectName: {
				list: [],
				selected: [],
				allSelected: true,
			},
			projectGroup: {
				list: [],
				selected: [],
				allSelected: true,
			},
			vulnerabilityName: {
				list: [],
				selected: [],
				allSelected: true,
			},
			level: {
				list: [],
				selected: [],
				allSelected: true,
			},
			status: {
				list: [],
				selected: [],
				allSelected: true,
			},
			batch: {
				list: [],
				selected: [],
				allSelected: true,
			},
			developer: {
				list: [],
				selected: [],
				allSelected: true,
			},
			repairTime: {
				list: [],
				selected: [],
				allSelected: true,
			},
		}
	},
	computed: {
		renderData() {
			let clone = this.bocData;

			return clone.filter(ele => {
				return this.general.selected.includes(ele.general) 
					&& this.branch.selected.includes(ele.branch)
					&& this.projectName.selected.includes(ele.projectName)
					&& this.projectGroup.selected.includes(ele.projectGroup)
					&& this.vulnerabilityName.selected.includes(ele.vulnerabilityName)
					&& this.level.selected.includes(ele.level)
					&& this.status.selected.includes(ele.status)
					&& this.batch.selected.includes(ele.batch)
					&& this.developer.selected.includes(ele.developer)
					&& this.repairTime.selected.includes(ele.averageRepairTime);
			});
		},
		rows() {
			return this.bocData.length;
		}		
	},
	mounted() {
		this.setOptions();
	},
	methods: {
		setOptions() {
			this.bocData.forEach(ele => {

				if (!(this.general.list.includes(ele.general))) {
					this.general.list.push(ele.general);
					this.general.selected = this.general.list;
				}

				if (!(this.branch.list.includes(ele.branch))) {
					this.branch.list.push(ele.branch);
					this.branch.selected = this.branch.list;
				}

				if (!(this.projectName.list.includes(ele.projectName))) {
					this.projectName.list.push(ele.projectName);
					this.projectName.selected = this.projectName.list;
				}

				if (!(this.projectGroup.list.includes(ele.projectGroup))) {
					this.projectGroup.list.push(ele.projectGroup);
					this.projectGroup.selected = this.projectGroup.list;
				}

				if (!(this.vulnerabilityName.list.includes(ele.vulnerabilityName))) {
					this.vulnerabilityName.list.push(ele.vulnerabilityName);
					this.vulnerabilityName.selected = this.vulnerabilityName.list;
				}

				if (!(this.level.list.includes(ele.level))) {
					this.level.list.push(ele.level);
					this.level.selected = this.level.list;
				}

				if (!(this.status.list.includes(ele.status))) {
					this.status.list.push(ele.status);
					this.status.selected = this.status.list;
				}

				if (!(this.batch.list.includes(ele.batch))) {
					this.batch.list.push(ele.batch);
					this.batch.selected = this.batch.list;
				}

				if (!(this.developer.list.includes(ele.developer))) {
					this.developer.list.push(ele.developer);
					this.developer.selected = this.developer.list;
				}

				if (!(this.repairTime.list.includes(ele.averageRepairTime))) {
					this.repairTime.list.push(ele.averageRepairTime);
					this.repairTime.selected = this.repairTime.list;
				}
			});
			this.repairTime.list.sort((a, b) => a - b);
			this.repairTime.list = this.repairTime.list.map(ele => {
				return {
					text: ele + '个工作日',
					value: ele
				}
			})
			this.batch.list.sort((a, b) => a - b);
		},
		toggleAll(option) {
			option.allSelected = !option.allSelected;
			option.selected = option.allSelected ? option.list.slice() : [];
		}
	},
	watch: {
		'general.selected'(newVal, oldVal) {
			if (newVal.length === this.general.list.length) {
				this.general.allSelected = true;
			} else {
				this.general.allSelected = false;
			}
		},
		'branch.selected'(newVal, oldVal) {
			if (newVal.length === this.branch.list.length) {
				this.branch.allSelected = true;
			} else {
				this.branch.allSelected = false;
			}
		},
		'projectName.selected'(newVal, oldVal) {
			if (newVal.length === this.projectName.list.length) {
				this.projectName.allSelected = true;
			} else {
				this.projectName.allSelected = false;
			}
		},
		'projectGroup.selected'(newVal, oldVal) {
			if (newVal.length === this.projectGroup.list.length) {
				this.projectGroup.allSelected = true;
			} else {
				this.projectGroup.allSelected = false;
			}
		},
		'vulnerabilityName.selected'(newVal, oldVal) {
			if (newVal.length === this.vulnerabilityName.list.length) {
				this.vulnerabilityName.allSelected = true;
			} else {
				this.vulnerabilityName.allSelected = false;
			}
		},
		'level.selected'(newVal, oldVal) {
			if (newVal.length === this.level.list.length) {
				this.level.allSelected = true;
			} else {
				this.level.allSelected = false;
			}
		},
		'status.selected'(newVal, oldVal) {
			if (newVal.length === this.status.list.length) {
				this.status.allSelected = true;
			} else {
				this.status.allSelected = false;
			}
		},
		'batch.selected'(newVal, oldVal) {
			if (newVal.length === this.batch.list.length) {
				this.batch.allSelected = true;
			} else {
				this.batch.allSelected = false;
			}
		},
		'developer.selected'(newVal, oldVal) {
			if (newVal.length === this.developer.list.length) {
				this.developer.allSelected = true;
			} else {
				this.developer.allSelected = false;
			}
		},
		'repairTime.selected'(newVal, oldVal) {
			if (newVal.length === this.repairTime.list.length) {
				this.repairTime.allSelected = true;
			} else {
				this.repairTime.allSelected = false;
			}
		},
	}
}
</script>

<style lang='less'>
.admin-overview {
	.overview-table {
		// table-layout:fixed;

		// td:nth-child(1) {
		// 	width: 6%;
		// }
		td:nth-child(2) {
			width: 9%;
		}
		// td:nth-child(3) {
		// 	width: 7%;
		// }
		// td:nth-child(4) {
		// 	width: 7%;
		// }
		td:nth-child(5) {
			width: 15%;
		}
		// td:nth-child(6) {
		// 	width: 7%;
		// }
		// td:nth-child(7) {
		// 	width: 7%;
		// }
		// td:nth-child(8) {
		// 	width: 10%;
		// }
		// td:nth-child(9) {
		// 	width: 5%;
		// }
		// td:nth-child(10) {
		// 	width: 7%;
		// }
		td:nth-child(11) {
			width: 8%;
		}

		.dropdown-menu {
			padding: 0;
		}

		.overview-table-filter {
			max-height:500px;
			max-width: 200px;
			white-space:nowrap;
			overflow-y:scroll;
			overflow-x:scroll;
			padding-left:10px;
			margin-bottom: 0;
		}
	}
}
</style>
