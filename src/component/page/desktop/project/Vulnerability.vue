<template>
	
<div>
	<b-breadcrumb
		:items="[
			{ text: '我的项目', href: '#/desktop/project' },
			{ text: '漏洞分析&报告', active: true }
		]"
	/>
	<h3 class="mt-3">漏洞分布</h3>
	<b-card-group>
    <b-card no-body>
			<chart-canvas
				style="height:200px"
				:options="{
					credits: { enabled: false },
					chart: { type: 'pie' },
					title: { text: null },
					plotOptions: {
						pie: {
							allowPointSelect: true,
							cursor: 'pointer',
							dataLabels: { enabled: false },
							showInLegend: true
						}
					},
					series: [{
						name: '数量',
						colorByPoint: true,
						data: [
							{ name: '高危', y: 35 },
							{ name: '中危', y: 214 },
							{ name: '低危', y: 101 }
						]
					}]
				}"
			/>
      <div slot="header">等级分布</div>
    </b-card>
    <b-card no-body>
      <b-card-text><visual-number value="35" /></b-card-text>
      <div slot="header">高度危险</div>
    </b-card>
    <b-card no-body>
      <b-card-text><visual-number value="214" /></b-card-text>
      <div slot="header">中等危险</div>
    </b-card>
    <b-card no-body>
      <b-card-text><visual-number value="101" /></b-card-text>
      <div slot="header">低等危险</div>
    </b-card>
  </b-card-group>

	<h3 class="mt-3">活跃的漏洞修复项目TOP10</h3>
	<b-table
		bordered
		small
		:items="fixed"
		:fields="[
			{ key: 'total', label: '修复总数', class: 'project-total-vulner' },
			{ key: 'name', label: '项目名称', class: 'project-name' },
			{ key: 'highVulner', label: '高', class: 'project-vulner-high' },
			{ key: 'mediumVulner', label: '中', class: 'project-vulner-medium' },
			{ key: 'lowVulner', label: '低', class: 'project-vulner-low' },
			{ key: 'perDay', label: '每日修复', class: 'project-fixing' },
			{ key: 'owner', label: '负责人', class: 'project-owner' },
		]"
	>
		<template slot="name" slot-scope="data">
			<a href="#/desktop/project/1">{{data.item.name}}</a>
		</template>
		<template slot="total" slot-scope="data">
			{{data.item.vulner.low+data.item.vulner.medium+data.item.vulner.high}}
		</template>
		<template slot="lowVulner" slot-scope="data">
			{{data.item.vulner.low}}
		</template>
		<template slot="mediumVulner" slot-scope="data">
			{{data.item.vulner.medium}}
		</template>
		<template slot="highVulner" slot-scope="data">
			{{data.item.vulner.high}}
		</template>
	</b-table>

	<h3 class="mt-3">项目漏洞总数排行</h3>
	<b-table
		bordered
		small
		:items="summary"
		:fields="[
			{ key: 'total', label: '总计', class: 'project-total-vulner' },
			{ key: 'name', label: '项目名称', class: 'project-name' },
			{ key: 'highVulner', label: '高', class: 'project-vulner-high' },
			{ key: 'mediumVulner', label: '中', class: 'project-vulner-medium' },
			{ key: 'lowVulner', label: '低', class: 'project-vulner-low' },
			{ key: 'chart', label: '分布', class: 'project-vulner-chart' },
			{ key: 'owner', label: '负责人', class: 'project-owner' },
		]"
	>
		<template slot="name" slot-scope="data">
			<a href="#/desktop/project/1">{{data.item.name}}</a>
		</template>
		<template slot="total" slot-scope="data">
			{{data.item.vulner.low+data.item.vulner.medium+data.item.vulner.high}}
		</template>
		<template slot="chart" slot-scope="data">
			<visual-progress
				:list="[
					{ value: data.item.vulner.high, variant: 'danger' },
					{ value: data.item.vulner.medium, variant: 'warning' },
					{ value: data.item.vulner.low, variant: 'info' }
				]"
			/>
		</template>
		<template slot="lowVulner" slot-scope="data">
			{{data.item.vulner.low}}
		</template>
		<template slot="mediumVulner" slot-scope="data">
			{{data.item.vulner.medium}}
		</template>
		<template slot="highVulner" slot-scope="data">
			{{data.item.vulner.high}}
		</template>
	</b-table>
	<h3 class="mt-3">历年漏洞跟踪</h3>
	<b-card-group>
    <b-card no-body>
			<chart-canvas
				style="height:360px"
				:options="{
					credits: { enabled: false },
					chart: { type: 'column' },
					title: { text: null },
					xAxis: { categories: yearCategory },
					yAxis: {
						stackLabels: { enabled: true }
					},
					plotOptions: {
						column: {
							stacking: 'normal',
						}
					},
					series: yearSeries
				}"
			/>
      <div slot="header">历年漏洞趋势</div>
    </b-card>

    <b-card no-body>
			<b-table
				small
				class="my-2 text-center"
				:items="year"
				:fields="[
					{ key: 'year', label: '年份' },
					{ key: 'high', label: '高' },
					{ key: 'medium', label: '中' },
					{ key: 'low', label: '低' },
					{ key: 'fixed', label: '全年修复' },
				]"
			></b-table>
      <div slot="header">历年漏洞统计</div>
    </b-card>
	</b-card-group>
	
	<h3 class="mt-3">漏洞类型TOP10</h3>
	<b-table
		small
		bordered
		:items="type"
		:fields="[
			{ key: 'name', label: '名称' },
			{ key: 'chart', label: '进度', class: 'type-chart' },
			{ key: 'total', label: '总数（次）' },
			{ key: 'fixed', label: '已修复（次）' },
		]"
	>
		<template slot="chart" slot-scope="data">
			<b-progress
				animated
				:value="data.item.fixed"
				:max="data.item.total"></b-progress>
		</template>
	</b-table>
</div>

</template>

<script>
function randomInt(from, to) {
	return Math.floor(from + Math.random() * (to- from));
}

function FixedTable() {
	return [
		'手机银行', '新版个人网银', '云盘系统', '直销银行手机银行',
		'移动银行信用卡专版', '管理会计系统', '数据集市平台',
		'供应链', '人力资源（实习专用）', '新版企业网银'
	].map(name => {
		return {
			name,
			vulner: {
				low: randomInt(3, 10),
				medium: randomInt(0, 18),
				high: randomInt(0, 8),
			},
			perDay: (Math.random() * 2).toFixed(1),
			owner: 'tengyue'
		}
	}).sort((itemA, itemB) => {
		return -(itemA.vulner.low + itemA.vulner.medium + itemA.vulner.high) +
			(itemB.vulner.low + itemB.vulner.medium + itemB.vulner.high);
	});
}

function SummaryTable() {
	return [
		'手机银行', '新版个人网银', '云盘系统', '直销银行手机银行',
		'移动银行信用卡专版', '管理会计系统', '数据集市平台',
		'供应链', '人力资源（实习专用）', '新版企业网银'
	].map(name => {
		return {
			name,
			vulner: {
				low: randomInt(8, 40),
				medium: randomInt(5, 35),
				high: randomInt(3, 10),
			},
			perDay: (Math.random() * 2).toFixed(1),
			owner: 'tengyue'
		}
	}).sort((itemA, itemB) => {
		return -(itemA.vulner.low + itemA.vulner.medium + itemA.vulner.high) +
			(itemB.vulner.low + itemB.vulner.medium + itemB.vulner.high);
	});
}

function YearTable() {
	return [2014, 2015, 2016, 2017, 2018, 2019].map(year => {
		return {
			year,
			low: randomInt(100, 150),
			medium: randomInt(100, 200),
			high: randomInt(50, 100),
			fixed: randomInt(120, 300)
		}
	});
}

function TypeTable() {
	return [
		'注入', '失效的身份认证', '敏感信息泄漏',
		'XML外部实体（XXE） [新]', '失效的访问控制 [合并]',
		'安全配置错误', '跨站脚本（XSS）', '不安全的反序列化 [新，来自于社区]',
		'使用含有已知漏洞的组件', '不足的日志记录和监控 [新，来自于社区]',
	].map(name => {
		const total = randomInt(80, 200);

		return {
			name,
			total,
			fixed: randomInt(total * 0.7, total)
		}
	}).sort((itemA, itemB) => itemB.total - itemA.total);
}

export default {
	data() {
		return {
			fixed: FixedTable(),
			summary: SummaryTable(),
			year: YearTable(),
			type: TypeTable()
		}
	},
	computed: {
		yearCategory() {
			return this.year.map(item => item.year);
		},
		yearSeries() {
			return this.year.reduce((series, item) => {
				series[2].data.push(item.low);
				series[1].data.push(item.medium);
				series[0].data.push(item.high);

				return series;
			}, [
				{ name: '高', data: [] },
				{ name: '中', data: [] },
				{ name: '低', data: [] }
			]);
		}
	}
}
</script>

<style lang="less">
.type-chart {
	width: 200px;
}
.project-total-vulner {
	width: 6em;
}
.project-vulner-low {
	width: 3em;
}
.project-vulner-medium {
	width: 3em;
}
.project-vulner-high {
	width: 3em;
}
.project-vulner-chart {
	width: 240px;
}
.project-fixing {
	width: 6em;
}
.project-owner {
	width: 8em;
}
</style>
